$ord=    "\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"
    @"\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f"
    @"\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f"
    @"\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f"
    @"\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f"
    @"\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f"
    @"\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f"
    @"\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f"
    @"\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f"
    @"\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f"
    @"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf"
    @"\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf"
    @"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf"
    @"\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf"
    @"\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef"
    @"\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"
    ;
$chr0  ="\x00";
$chr1  ="\x01";$chr2  ="\x02";$chr3  ="\x03";$chr4  ="\x04";$chr5  ="\x05";
$chr6  ="\x06";$chr7  ="\x07";$chr8  ="\x08";$chr9  ="\x09";$chr10 ="\x0a";
$chr11 ="\x0b";$chr12 ="\x0c";$chr13 ="\x0d";$chr14 ="\x0e";$chr15 ="\x0f";
$chr16 ="\x10";$chr17 ="\x11";$chr18 ="\x12";$chr19 ="\x13";$chr20 ="\x14";
$chr21 ="\x15";$chr22 ="\x16";$chr23 ="\x17";$chr24 ="\x18";$chr25 ="\x19";
$chr26 ="\x1a";$chr27 ="\x1b";$chr28 ="\x1c";$chr29 ="\x1d";$chr30 ="\x1e";
$chr31 ="\x1f";$chr32 ="\x20";$chr33 ="\x21";$chr34 ="\x22";$chr35 ="\x23";
$chr36 ="\x24";$chr37 ="\x25";$chr38 ="\x26";$chr39 ="\x27";$chr40 ="\x28";
$chr41 ="\x29";$chr42 ="\x2a";$chr43 ="\x2b";$chr44 ="\x2c";$chr45 ="\x2d";
$chr46 ="\x2e";$chr47 ="\x2f";$chr48 ="\x30";$chr49 ="\x31";$chr50 ="\x32";
$chr51 ="\x33";$chr52 ="\x34";$chr53 ="\x35";$chr54 ="\x36";$chr55 ="\x37";
$chr56 ="\x38";$chr57 ="\x39";$chr58 ="\x3a";$chr59 ="\x3b";$chr60 ="\x3c";
$chr61 ="\x3d";$chr62 ="\x3e";$chr63 ="\x3f";$chr64 ="\x40";$chr65 ="\x41";
$chr66 ="\x42";$chr67 ="\x43";$chr68 ="\x44";$chr69 ="\x45";$chr70 ="\x46";
$chr71 ="\x47";$chr72 ="\x48";$chr73 ="\x49";$chr74 ="\x4a";$chr75 ="\x4b";
$chr76 ="\x4c";$chr77 ="\x4d";$chr78 ="\x4e";$chr79 ="\x4f";$chr80 ="\x50";
$chr81 ="\x51";$chr82 ="\x52";$chr83 ="\x53";$chr84 ="\x54";$chr85 ="\x55";
$chr86 ="\x56";$chr87 ="\x57";$chr88 ="\x58";$chr89 ="\x59";$chr90 ="\x5a";
$chr91 ="\x5b";$chr92 ="\x5c";$chr93 ="\x5d";$chr94 ="\x5e";$chr95 ="\x5f";
$chr96 ="\x60";$chr97 ="\x61";$chr98 ="\x62";$chr99 ="\x63";$chr100="\x64";
$chr101="\x65";$chr102="\x66";$chr103="\x67";$chr104="\x68";$chr105="\x69";
$chr106="\x6a";$chr107="\x6b";$chr108="\x6c";$chr109="\x6d";$chr110="\x6e";
$chr111="\x6f";$chr112="\x70";$chr113="\x71";$chr114="\x72";$chr115="\x73";
$chr116="\x74";$chr117="\x75";$chr118="\x76";$chr119="\x77";$chr120="\x78";
$chr121="\x79";$chr122="\x7a";$chr123="\x7b";$chr124="\x7c";$chr125="\x7d";
$chr126="\x7e";$chr127="\x7f";$chr128="\x80";$chr129="\x81";$chr130="\x82";
$chr131="\x83";$chr132="\x84";$chr133="\x85";$chr134="\x86";$chr135="\x87";
$chr136="\x88";$chr137="\x89";$chr138="\x8a";$chr139="\x8b";$chr140="\x8c";
$chr141="\x8d";$chr142="\x8e";$chr143="\x8f";$chr144="\x90";$chr145="\x91";
$chr146="\x92";$chr147="\x93";$chr148="\x94";$chr149="\x95";$chr150="\x96";
$chr151="\x97";$chr152="\x98";$chr153="\x99";$chr154="\x9a";$chr155="\x9b";
$chr156="\x9c";$chr157="\x9d";$chr158="\x9e";$chr159="\x9f";$chr160="\xa0";
$chr161="\xa1";$chr162="\xa2";$chr163="\xa3";$chr164="\xa4";$chr165="\xa5";
$chr166="\xa6";$chr167="\xa7";$chr168="\xa8";$chr169="\xa9";$chr170="\xaa";
$chr171="\xab";$chr172="\xac";$chr173="\xad";$chr174="\xae";$chr175="\xaf";
$chr176="\xb0";$chr177="\xb1";$chr178="\xb2";$chr179="\xb3";$chr180="\xb4";
$chr181="\xb5";$chr182="\xb6";$chr183="\xb7";$chr184="\xb8";$chr185="\xb9";
$chr186="\xba";$chr187="\xbb";$chr188="\xbc";$chr189="\xbd";$chr190="\xbe";
$chr191="\xbf";$chr192="\xc0";$chr193="\xc1";$chr194="\xc2";$chr195="\xc3";
$chr196="\xc4";$chr197="\xc5";$chr198="\xc6";$chr199="\xc7";$chr200="\xc8";
$chr201="\xc9";$chr202="\xca";$chr203="\xcb";$chr204="\xcc";$chr205="\xcd";
$chr206="\xce";$chr207="\xcf";$chr208="\xd0";$chr209="\xd1";$chr210="\xd2";
$chr211="\xd3";$chr212="\xd4";$chr213="\xd5";$chr214="\xd6";$chr215="\xd7";
$chr216="\xd8";$chr217="\xd9";$chr218="\xda";$chr219="\xdb";$chr220="\xdc";
$chr221="\xdd";$chr222="\xde";$chr223="\xdf";$chr224="\xe0";$chr225="\xe1";
$chr226="\xe2";$chr227="\xe3";$chr228="\xe4";$chr229="\xe5";$chr230="\xe6";
$chr231="\xe7";$chr232="\xe8";$chr233="\xe9";$chr234="\xea";$chr235="\xeb";
$chr236="\xec";$chr237="\xed";$chr238="\xee";$chr239="\xef";$chr240="\xf0";
$chr241="\xf1";$chr242="\xf2";$chr243="\xf3";$chr244="\xf4";$chr245="\xf5";
$chr246="\xf6";$chr247="\xf7";$chr248="\xf8";$chr249="\xf9";$chr250="\xfa";
$chr251="\xfb";$chr252="\xfc";$chr253="\xfd";$chr254="\xfe";$chr255="\xff";
$hex80  ="00";
$hex81  ="01";$hex82  ="02";$hex83  ="03";$hex84  ="04";$hex85  ="05";
$hex86  ="06";$hex87  ="07";$hex88  ="08";$hex89  ="09";$hex810 ="0a";
$hex811 ="0b";$hex812 ="0c";$hex813 ="0d";$hex814 ="0e";$hex815 ="0f";
$hex816 ="10";$hex817 ="11";$hex818 ="12";$hex819 ="13";$hex820 ="14";
$hex821 ="15";$hex822 ="16";$hex823 ="17";$hex824 ="18";$hex825 ="19";
$hex826 ="1a";$hex827 ="1b";$hex828 ="1c";$hex829 ="1d";$hex830 ="1e";
$hex831 ="1f";$hex832 ="20";$hex833 ="21";$hex834 ="22";$hex835 ="23";
$hex836 ="24";$hex837 ="25";$hex838 ="26";$hex839 ="27";$hex840 ="28";
$hex841 ="29";$hex842 ="2a";$hex843 ="2b";$hex844 ="2c";$hex845 ="2d";
$hex846 ="2e";$hex847 ="2f";$hex848 ="30";$hex849 ="31";$hex850 ="32";
$hex851 ="33";$hex852 ="34";$hex853 ="35";$hex854 ="36";$hex855 ="37";
$hex856 ="38";$hex857 ="39";$hex858 ="3a";$hex859 ="3b";$hex860 ="3c";
$hex861 ="3d";$hex862 ="3e";$hex863 ="3f";$hex864 ="40";$hex865 ="41";
$hex866 ="42";$hex867 ="43";$hex868 ="44";$hex869 ="45";$hex870 ="46";
$hex871 ="47";$hex872 ="48";$hex873 ="49";$hex874 ="4a";$hex875 ="4b";
$hex876 ="4c";$hex877 ="4d";$hex878 ="4e";$hex879 ="4f";$hex880 ="50";
$hex881 ="51";$hex882 ="52";$hex883 ="53";$hex884 ="54";$hex885 ="55";
$hex886 ="56";$hex887 ="57";$hex888 ="58";$hex889 ="59";$hex890 ="5a";
$hex891 ="5b";$hex892 ="5c";$hex893 ="5d";$hex894 ="5e";$hex895 ="5f";
$hex896 ="60";$hex897 ="61";$hex898 ="62";$hex899 ="63";$hex8100="64";
$hex8101="65";$hex8102="66";$hex8103="67";$hex8104="68";$hex8105="69";
$hex8106="6a";$hex8107="6b";$hex8108="6c";$hex8109="6d";$hex8110="6e";
$hex8111="6f";$hex8112="70";$hex8113="71";$hex8114="72";$hex8115="73";
$hex8116="74";$hex8117="75";$hex8118="76";$hex8119="77";$hex8120="78";
$hex8121="79";$hex8122="7a";$hex8123="7b";$hex8124="7c";$hex8125="7d";
$hex8126="7e";$hex8127="7f";$hex8128="80";$hex8129="81";$hex8130="82";
$hex8131="83";$hex8132="84";$hex8133="85";$hex8134="86";$hex8135="87";
$hex8136="88";$hex8137="89";$hex8138="8a";$hex8139="8b";$hex8140="8c";
$hex8141="8d";$hex8142="8e";$hex8143="8f";$hex8144="90";$hex8145="91";
$hex8146="92";$hex8147="93";$hex8148="94";$hex8149="95";$hex8150="96";
$hex8151="97";$hex8152="98";$hex8153="99";$hex8154="9a";$hex8155="9b";
$hex8156="9c";$hex8157="9d";$hex8158="9e";$hex8159="9f";$hex8160="a0";
$hex8161="a1";$hex8162="a2";$hex8163="a3";$hex8164="a4";$hex8165="a5";
$hex8166="a6";$hex8167="a7";$hex8168="a8";$hex8169="a9";$hex8170="aa";
$hex8171="ab";$hex8172="ac";$hex8173="ad";$hex8174="ae";$hex8175="af";
$hex8176="b0";$hex8177="b1";$hex8178="b2";$hex8179="b3";$hex8180="b4";
$hex8181="b5";$hex8182="b6";$hex8183="b7";$hex8184="b8";$hex8185="b9";
$hex8186="ba";$hex8187="bb";$hex8188="bc";$hex8189="bd";$hex8190="be";
$hex8191="bf";$hex8192="c0";$hex8193="c1";$hex8194="c2";$hex8195="c3";
$hex8196="c4";$hex8197="c5";$hex8198="c6";$hex8199="c7";$hex8200="c8";
$hex8201="c9";$hex8202="ca";$hex8203="cb";$hex8204="cc";$hex8205="cd";
$hex8206="ce";$hex8207="cf";$hex8208="d0";$hex8209="d1";$hex8210="d2";
$hex8211="d3";$hex8212="d4";$hex8213="d5";$hex8214="d6";$hex8215="d7";
$hex8216="d8";$hex8217="d9";$hex8218="da";$hex8219="db";$hex8220="dc";
$hex8221="dd";$hex8222="de";$hex8223="df";$hex8224="e0";$hex8225="e1";
$hex8226="e2";$hex8227="e3";$hex8228="e4";$hex8229="e5";$hex8230="e6";
$hex8231="e7";$hex8232="e8";$hex8233="e9";$hex8234="ea";$hex8235="eb";
$hex8236="ec";$hex8237="ed";$hex8238="ee";$hex8239="ef";$hex8240="f0";
$hex8241="f1";$hex8242="f2";$hex8243="f3";$hex8244="f4";$hex8245="f5";
$hex8246="f6";$hex8247="f7";$hex8248="f8";$hex8249="f9";$hex8250="fa";
$hex8251="fb";$hex8252="fc";$hex8253="fd";$hex8254="fe";$hex8255="ff";
$utf8d0  =  0;$utf8d1  =  0;$utf8d2  =  0;$utf8d3  =  0;$utf8d4  =  0;
$utf8d5  =  0;$utf8d6  =  0;$utf8d7  =  0;$utf8d8  =  0;$utf8d9  =  0;
$utf8d10 =  0;$utf8d11 =  0;$utf8d12 =  0;$utf8d13 =  0;$utf8d14 =  0;
$utf8d15 =  0;$utf8d16 =  0;$utf8d17 =  0;$utf8d18 =  0;$utf8d19 =  0;
$utf8d20 =  0;$utf8d21 =  0;$utf8d22 =  0;$utf8d23 =  0;$utf8d24 =  0;
$utf8d25 =  0;$utf8d26 =  0;$utf8d27 =  0;$utf8d28 =  0;$utf8d29 =  0;
$utf8d30 =  0;$utf8d31 =  0;$utf8d32 =  0;$utf8d33 =  0;$utf8d34 =  0;
$utf8d35 =  0;$utf8d36 =  0;$utf8d37 =  0;$utf8d38 =  0;$utf8d39 =  0;
$utf8d40 =  0;$utf8d41 =  0;$utf8d42 =  0;$utf8d43 =  0;$utf8d44 =  0;
$utf8d45 =  0;$utf8d46 =  0;$utf8d47 =  0;$utf8d48 =  0;$utf8d49 =  0;
$utf8d50 =  0;$utf8d51 =  0;$utf8d52 =  0;$utf8d53 =  0;$utf8d54 =  0;
$utf8d55 =  0;$utf8d56 =  0;$utf8d57 =  0;$utf8d58 =  0;$utf8d59 =  0;
$utf8d60 =  0;$utf8d61 =  0;$utf8d62 =  0;$utf8d63 =  0;$utf8d64 =  0;
$utf8d65 =  0;$utf8d66 =  0;$utf8d67 =  0;$utf8d68 =  0;$utf8d69 =  0;
$utf8d70 =  0;$utf8d71 =  0;$utf8d72 =  0;$utf8d73 =  0;$utf8d74 =  0;
$utf8d75 =  0;$utf8d76 =  0;$utf8d77 =  0;$utf8d78 =  0;$utf8d79 =  0;
$utf8d80 =  0;$utf8d81 =  0;$utf8d82 =  0;$utf8d83 =  0;$utf8d84 =  0;
$utf8d85 =  0;$utf8d86 =  0;$utf8d87 =  0;$utf8d88 =  0;$utf8d89 =  0;
$utf8d90 =  0;$utf8d91 =  0;$utf8d92 =  0;$utf8d93 =  0;$utf8d94 =  0;
$utf8d95 =  0;$utf8d96 =  0;$utf8d97 =  0;$utf8d98 =  0;$utf8d99 =  0;
$utf8d100=  0;$utf8d101=  0;$utf8d102=  0;$utf8d103=  0;$utf8d104=  0;
$utf8d105=  0;$utf8d106=  0;$utf8d107=  0;$utf8d108=  0;$utf8d109=  0;
$utf8d110=  0;$utf8d111=  0;$utf8d112=  0;$utf8d113=  0;$utf8d114=  0;
$utf8d115=  0;$utf8d116=  0;$utf8d117=  0;$utf8d118=  0;$utf8d119=  0;
$utf8d120=  0;$utf8d121=  0;$utf8d122=  0;$utf8d123=  0;$utf8d124=  0;
$utf8d125=  0;$utf8d126=  0;$utf8d127=  0;$utf8d128=  1;$utf8d129=  1;
$utf8d130=  1;$utf8d131=  1;$utf8d132=  1;$utf8d133=  1;$utf8d134=  1;
$utf8d135=  1;$utf8d136=  1;$utf8d137=  1;$utf8d138=  1;$utf8d139=  1;
$utf8d140=  1;$utf8d141=  1;$utf8d142=  1;$utf8d143=  1;$utf8d144=  9;
$utf8d145=  9;$utf8d146=  9;$utf8d147=  9;$utf8d148=  9;$utf8d149=  9;
$utf8d150=  9;$utf8d151=  9;$utf8d152=  9;$utf8d153=  9;$utf8d154=  9;
$utf8d155=  9;$utf8d156=  9;$utf8d157=  9;$utf8d158=  9;$utf8d159=  9;
$utf8d160=  7;$utf8d161=  7;$utf8d162=  7;$utf8d163=  7;$utf8d164=  7;
$utf8d165=  7;$utf8d166=  7;$utf8d167=  7;$utf8d168=  7;$utf8d169=  7;
$utf8d170=  7;$utf8d171=  7;$utf8d172=  7;$utf8d173=  7;$utf8d174=  7;
$utf8d175=  7;$utf8d176=  7;$utf8d177=  7;$utf8d178=  7;$utf8d179=  7;
$utf8d180=  7;$utf8d181=  7;$utf8d182=  7;$utf8d183=  7;$utf8d184=  7;
$utf8d185=  7;$utf8d186=  7;$utf8d187=  7;$utf8d188=  7;$utf8d189=  7;
$utf8d190=  7;$utf8d191=  7;$utf8d192=  8;$utf8d193=  8;$utf8d194=  2;
$utf8d195=  2;$utf8d196=  2;$utf8d197=  2;$utf8d198=  2;$utf8d199=  2;
$utf8d200=  2;$utf8d201=  2;$utf8d202=  2;$utf8d203=  2;$utf8d204=  2;
$utf8d205=  2;$utf8d206=  2;$utf8d207=  2;$utf8d208=  2;$utf8d209=  2;
$utf8d210=  2;$utf8d211=  2;$utf8d212=  2;$utf8d213=  2;$utf8d214=  2;
$utf8d215=  2;$utf8d216=  2;$utf8d217=  2;$utf8d218=  2;$utf8d219=  2;
$utf8d220=  2;$utf8d221=  2;$utf8d222=  2;$utf8d223=  2;$utf8d224= 10;
$utf8d225=  3;$utf8d226=  3;$utf8d227=  3;$utf8d228=  3;$utf8d229=  3;
$utf8d230=  3;$utf8d231=  3;$utf8d232=  3;$utf8d233=  3;$utf8d234=  3;
$utf8d235=  3;$utf8d236=  3;$utf8d237=  4;$utf8d238=  3;$utf8d239=  3;
$utf8d240= 11;$utf8d241=  6;$utf8d242=  6;$utf8d243=  6;$utf8d244=  5;
$utf8d245=  8;$utf8d246=  8;$utf8d247=  8;$utf8d248=  8;$utf8d249=  8;
$utf8d250=  8;$utf8d251=  8;$utf8d252=  8;$utf8d253=  8;$utf8d254=  8;
$utf8d255=  8;$utf8d256=  0;$utf8d257= 12;$utf8d258= 24;$utf8d259= 36;
$utf8d260= 60;$utf8d261= 96;$utf8d262= 84;$utf8d263= 12;$utf8d264= 12;
$utf8d265= 12;$utf8d266= 48;$utf8d267= 72;$utf8d268= 12;$utf8d269= 12;
$utf8d270= 12;$utf8d271= 12;$utf8d272= 12;$utf8d273= 12;$utf8d274= 12;
$utf8d275= 12;$utf8d276= 12;$utf8d277= 12;$utf8d278= 12;$utf8d279= 12;
$utf8d280= 12;$utf8d281=  0;$utf8d282= 12;$utf8d283= 12;$utf8d284= 12;
$utf8d285= 12;$utf8d286= 12;$utf8d287=  0;$utf8d288= 12;$utf8d289=  0;
$utf8d290= 12;$utf8d291= 12;$utf8d292= 12;$utf8d293= 24;$utf8d294= 12;
$utf8d295= 12;$utf8d296= 12;$utf8d297= 12;$utf8d298= 12;$utf8d299= 24;
$utf8d300= 12;$utf8d301= 24;$utf8d302= 12;$utf8d303= 12;$utf8d304= 12;
$utf8d305= 12;$utf8d306= 12;$utf8d307= 12;$utf8d308= 12;$utf8d309= 12;
$utf8d310= 12;$utf8d311= 24;$utf8d312= 12;$utf8d313= 12;$utf8d314= 12;
$utf8d315= 12;$utf8d316= 12;$utf8d317= 24;$utf8d318= 12;$utf8d319= 12;
$utf8d320= 12;$utf8d321= 12;$utf8d322= 12;$utf8d323= 12;$utf8d324= 12;
$utf8d325= 24;$utf8d326= 12;$utf8d327= 12;$utf8d328= 12;$utf8d329= 12;
$utf8d330= 12;$utf8d331= 12;$utf8d332= 12;$utf8d333= 12;$utf8d334= 12;
$utf8d335= 36;$utf8d336= 12;$utf8d337= 36;$utf8d338= 12;$utf8d339= 12;
$utf8d340= 12;$utf8d341= 36;$utf8d342= 12;$utf8d343= 12;$utf8d344= 12;
$utf8d345= 12;$utf8d346= 12;$utf8d347= 36;$utf8d348= 12;$utf8d349= 36;
$utf8d350= 12;$utf8d351= 12;$utf8d352= 12;$utf8d353= 36;$utf8d354= 12;
$utf8d355= 12;$utf8d356= 12;$utf8d357= 12;$utf8d358= 12;$utf8d359= 12;
$utf8d360= 12;$utf8d361= 12;$utf8d362= 12;$utf8d363= 12;$utf8d364=119;

$UTF8_INVALID = 0x11000;

// function utf8_decode(%str)
// {
//   %state = 0;
//   %codep = 0;
//
//   for (%i = 0; %i < 4; %i++)
//   {
//     %type = $utf8d[%byte = strpos($ord, getSubStr(%str, %i, "1")) + 1] | 0;
//     %codep = (%state != 0) ?
//        (%byte & 0x3f) | (%codep << 6) : (0xff >> %type) & %byte;
//
//     if ((%state = $utf8d[256 + %state + %type]) < 2)
//       break;
//   }
//
//   $utf8_i = %i + 1;
//   return %state == 0 ? %codep : $UTF8_INVALID;
// }

// Manually unrolled loop version of above function

function utf8_decode(%str)
{
  %type = $utf8d[%byte = strpos($ord, getSubStr(%str, "0", "1")) + 1] | 0;
  %codep = (0xff >> %type) & %byte;

  if ((%state = $utf8d[256 + %type]) < 2)
  {
    $utf8_i = 1;
    return %state == 0 ? %codep : $UTF8_INVALID;
  }

  %type = $utf8d[%byte = strpos($ord, getSubStr(%str, "1", "1")) + 1] | 0;
  %codep = (%byte & 0x3f) | (%codep << 6);

  if ((%state = $utf8d[256 + %state + %type]) < 2)
  {
    $utf8_i = 2;
    return %state == 0 ? %codep : $UTF8_INVALID;
  }

  %type = $utf8d[%byte = strpos($ord, getSubStr(%str, "2", "1")) + 1] | 0;
  %codep = (%byte & 0x3f) | (%codep << 6);

  if ((%state = $utf8d[256 + %state + %type]) < 2)
  {
    $utf8_i = 3;
    return %state == 0 ? %codep : $UTF8_INVALID;
  }

  %type = $utf8d[%byte = strpos($ord, getSubStr(%str, "3", "1")) + 1] | 0;
  %codep = (%byte & 0x3f) | (%codep << 6);

  $utf8_i = 4;
  return (%state = $utf8d[256 + %state + %type]) == 0 ? %codep : $UTF8_INVALID;
}

function utf8_encode(%cp)
{
  if (%cp < 0x80)
    return $chr[%cp];
  if (%cp < 0x800)
    return
      $chr[(%cp >> 6)   | 0xc0] @
      $chr[(%cp & 0x3f) | 0x80] ;
  if (%cp < 0x10000)
    return
      $chr[ (%cp >> 12)         | 0xe0] @
      $chr[((%cp >>  6) & 0x3f) | 0x80] @
      $chr[ (%cp        & 0x3f) | 0x80] ;
  if (%cp < 0x110000)
    return
      $chr[ (%cp >> 18)         | 0xf0] @
      $chr[((%cp >> 12) & 0x3f) | 0x80] @
      $chr[((%cp >>  6) & 0x3f) | 0x80] @
      $chr[ (%cp        & 0x3f) | 0x80] ;
  return "";
}

function utf8_len(%str)
{
  %len = strlen(%str);

  for (%n = 0; %str !$= ""; %n++)
  {
    utf8_decode(%str);
    %str = getSubStr(%str, $utf8_i, %len);
  }

  return %n;
}

function cp1252_to_utf8(%str)
{
  %len = strlen(%str);

  while (%str !$= "")
  {
    %cp = strpos($ord, getSubStr(%str, "0", "1")) + 1;

    if (%cp <= 0x7f)
      %out = %out @ $chr[%cp];
    else if (%cp >= 0xa0)
      %out = %out @ $chr[(%cp >> 6) | 0xc0] @ $chr[(%cp & 0x3f) | 0x80];
    else
      %out = %out @ $cp1252_to_utf8[%cp];

    %str = getSubStr(%str, "1", %len);
  }

  return %out;
}

function utf8_to_cp1252(%str, %error)
{
  %len = strlen(%str);

  while (%str !$= "")
  {
    %cp = utf8_decode(%str) | 0;
    %str = getSubStr(%str, $utf8_i, %len);

    if ((%cp <= 0x7f) || (%cp >= 0xa0 && %cp <= 0xff))
      %out = %out @ $chr[%cp];
    else if ($unicode_to_cp1252[%cp] !$= "")
      %out = %out @ $unicode_to_cp1252[%cp];
    else
      %out = %out @ %error;
  }

  return %out;
}

function escapeBytes(%str)
{
  %len = strlen(%str);

  while (%str !$= "")
  {
    %out = %out @ "\\x" @ $hex8[strpos($ord, getSubStr(%str, "0", "1")) + 1];
    %str = getSubStr(%str, "1", %len);
  }

  return %out;
}

function leftPad(%str, %len, %pad)
{
  %len = %len - strlen(%str);

  while (%len-- >= 0)
    %str = %pad @ %str;

  return %str;
}

function rightPad(%str, %len, %pad)
{
  %len = %len - strlen(%str);

  while (%len-- >= 0)
    %str = %str @ %pad;

  return %str;
}

function repeat(%str, %times)
{
  while (%times-- >= 0)
    %out = %out @ %str;

  return %out;
}

function strEndsWith(%str, %end)
{
  %len = strlen(%end);
  return strcmp(%end, getSubStr(%str, strlen(%str) - %len, %len)) == 0;
}

function striEndsWith(%str, %end)
{
  %len = strlen(%end);
  return %end $= getSubStr(%str, strlen(%str) - %len, %len);
}

function strStartsWith(%str, %start)
{
  return strcmp(%start, getSubStr(%str, 0, strlen(%start))) == 0;
}

function striStartsWith(%str, %start)
{
  return %start $= getSubStr(%str, 0, strlen(%start));
}

$cp1252_to_unicode[0x80] = 0x20ac;
$cp1252_to_unicode[0x82] = 0x201a;
$cp1252_to_unicode[0x83] = 0x0192;
$cp1252_to_unicode[0x84] = 0x201e;
$cp1252_to_unicode[0x85] = 0x2026;
$cp1252_to_unicode[0x86] = 0x2020;
$cp1252_to_unicode[0x87] = 0x2021;
$cp1252_to_unicode[0x88] = 0x02c6;
$cp1252_to_unicode[0x89] = 0x2030;
$cp1252_to_unicode[0x8a] = 0x0160;
$cp1252_to_unicode[0x8b] = 0x2039;
$cp1252_to_unicode[0x8c] = 0x0152;
$cp1252_to_unicode[0x8e] = 0x017d;
$cp1252_to_unicode[0x91] = 0x2018;
$cp1252_to_unicode[0x92] = 0x2019;
$cp1252_to_unicode[0x93] = 0x201c;
$cp1252_to_unicode[0x94] = 0x201d;
$cp1252_to_unicode[0x95] = 0x2022;
$cp1252_to_unicode[0x96] = 0x2013;
$cp1252_to_unicode[0x97] = 0x2014;
$cp1252_to_unicode[0x98] = 0x02dc;
$cp1252_to_unicode[0x99] = 0x2122;
$cp1252_to_unicode[0x9a] = 0x0161;
$cp1252_to_unicode[0x9b] = 0x203a;
$cp1252_to_unicode[0x9c] = 0x0153;
$cp1252_to_unicode[0x9e] = 0x017e;
$cp1252_to_unicode[0x9f] = 0x0178;

$cp1252_to_utf8128="\xe2\x82\xac";
$cp1252_to_utf8130="\xe2\x80\x9a";
$cp1252_to_utf8131="\xc6\x92";
$cp1252_to_utf8132="\xe2\x80\x9e";
$cp1252_to_utf8133="\xe2\x80\xa6";
$cp1252_to_utf8134="\xe2\x80\xa0";
$cp1252_to_utf8135="\xe2\x80\xa1";
$cp1252_to_utf8136="\xcb\x86";
$cp1252_to_utf8137="\xe2\x80\xb0";
$cp1252_to_utf8138="\xc5\xa0";
$cp1252_to_utf8139="\xe2\x80\xb9";
$cp1252_to_utf8140="\xc5\x92";
$cp1252_to_utf8142="\xc5\xbd";
$cp1252_to_utf8145="\xe2\x80\x98";
$cp1252_to_utf8146="\xe2\x80\x99";
$cp1252_to_utf8147="\xe2\x80\x9c";
$cp1252_to_utf8148="\xe2\x80\x9d";
$cp1252_to_utf8149="\xe2\x80\xa2";
$cp1252_to_utf8150="\xe2\x80\x93";
$cp1252_to_utf8151="\xe2\x80\x94";
$cp1252_to_utf8152="\xcb\x9c";
$cp1252_to_utf8153="\xe2\x84\xa2";
$cp1252_to_utf8154="\xc5\xa1";
$cp1252_to_utf8155="\xe2\x80\xba";
$cp1252_to_utf8156="\xc5\x93";
$cp1252_to_utf8158="\xc5\xbe";
$cp1252_to_utf8159="\xc5\xb8";
$unicode_to_cp12528364="\x80";
$unicode_to_cp12528218="\x82";
$unicode_to_cp1252402 ="\x83";
$unicode_to_cp12528222="\x84";
$unicode_to_cp12528230="\x85";
$unicode_to_cp12528224="\x86";
$unicode_to_cp12528225="\x87";
$unicode_to_cp1252710 ="\x88";
$unicode_to_cp12528240="\x89";
$unicode_to_cp1252352 ="\x8a";
$unicode_to_cp12528249="\x8b";
$unicode_to_cp1252338 ="\x8c";
$unicode_to_cp1252381 ="\x8e";
$unicode_to_cp12528216="\x91";
$unicode_to_cp12528217="\x92";
$unicode_to_cp12528220="\x93";
$unicode_to_cp12528221="\x94";
$unicode_to_cp12528226="\x95";
$unicode_to_cp12528211="\x96";
$unicode_to_cp12528212="\x97";
$unicode_to_cp1252732 ="\x98";
$unicode_to_cp12528482="\x99";
$unicode_to_cp1252353 ="\x9a";
$unicode_to_cp12528250="\x9b";
$unicode_to_cp1252339 ="\x9c";
$unicode_to_cp1252382 ="\x9e";
$unicode_to_cp1252376 ="\x9f";

// function gen_cp1252_tab()
// {
//   for (%i = 0x00; %i <= 0xff; %i++)
//   {
//     %j = $cp1252_to_unicode[%i];
//
//     if (%j $= "")
//       continue;
//
//     %a = %a
//       @ "$cp1252_to_utf8" @ %i @ "=\""
//       @ escapeBytes(utf8_encode(%j)) @ "\";\n";
//
//     %b = %b
//       @ "$unicode_to_cp1252" @ rightPad(%j, 4, " ") @ "=\""
//       @ escapeBytes($chr[%i]) @ "\";\n";
//   }
//
//   return %a @ %b;
// }

function echof(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
  %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18)
{
  echo(format(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
    %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18));
}

function warnf(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
  %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18)
{
  warn(format(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
    %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18));
}

function errorf(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
  %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18)
{
  error(format(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
    %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18));
}

function _format_num(%fmt, %i, %len)
{
	while (%i < %len)
	{
		%chr = getSubStr(%fmt, %i, 1);

		if (strpos("0123456789", %chr) == -1)
			break;

		%out = %out @ %chr;
		%i++;
	}

  $_ret1 = %i;
  return %out;
}

function format(%fmt, %a0, %a1, %a2, %a3, %a4, %a5, %a6, %a7, %a8, %a9, %a10,
  %a11, %a12, %a13, %a14, %a15, %a16, %a17, %a18)
{
  %argn = 0;
  %len = strlen(%fmt);
  %i = 0;

  while (%i < %len)
  {
    // search for a format
    %j = strpos(%fmt, "%", %i);

    if (%j == -1)
      return %out @ getSubStr(%fmt, %i, %len);

    if (%i != %j)
      %out = %out @ getSubStr(%fmt, %i, %j - %i);

    %j++; // go past the actual % sign

    if (%j >= %len) // trailing % produces raw %
      return %out @ "%";

    if ((%chr = getSubStr(%fmt, %j, 1)) $= "%")
    {
      %out = %out @ "%";
      %i = %j++;
      continue;
    }

    // read flags
    //     +: prefix positive numbers with +
    // space: prefix positive numbers with space
    //     -: pad width on the right (left-align) instead
    //     #: use alternate form
    //     0: use 0 instead of spaces to pad width
    %flag_always_sign = 0;
    %flag_space_sign = 0;
    %flag_alternate = 0;
    %padside = 1;
    %padchar = " ";

    while (%j < %len)
    {
      switch$ (%chr)
      {
        case "+": %flag_always_sign = 1;
        case " ": %flag_space_sign = 1;
        case "-": %padside = 0;
        case "#": %flag_alternate = 1;
        case "0": %padchar = "0";
        default: break;
      }

      %chr = getSubStr(%fmt, %j++, 1);
    }

    // read width
    %padsize = _format_num(%fmt, %j, %len);
    %j = $_ret1;

    if (%padsize !$= "")
      %chr = getSubStr(%fmt, %j, 1);

    // read precision
    if (%chr $= ".")
    {
      %precision = _format_num(%fmt, %j + 1, %len);
      %j = $_ret1;

      if (%precision $= "") // invalid format, add and move along
      {
        %out = %out @ getSubStr(%fmt, %i, %j - %i);
        %i = %j;
        continue;
      }

      if (%precision !$= "")
      {
        %chr = getSubStr(%fmt, %j, 1);
        %j++;
      }

      if (%precision == 0)
        %precision = "";
    }
    else
      %precision = "";

    %chunk = "";
    %value = %a[%argn];
    %argn++;

    switch$ (%chr)
    {
      case "d" or "i":
        %value |= 0;

        if (%flag_always_sign && %value >= 0)
          %chunk = "+" @ %value;
        else if (%flag_space_sign && %value >= 0)
          %chunk = " " @ %value;
        else
          %chunk = %value;

      // %u

      case "o":
        %value |= 0;

        if (%value == 0)
          %chunk = "0";

        while (%value != 0)
        {
          %chunk = getSubStr("01234567", %value & 7, "1") @ %chunk;
          %value >>= 3;
        }

      case "x":
        %value |= 0;
        %chars = strcmp(%chr, "X") == 0 ? "0123456789ABCDEF" : "0123456789abcdef";

        if (%value == 0)
          %chunk = "0";

        while (%value != 0)
        {
          %chunk = getSubStr(%chars, %value & 15, "1") @ %chunk;
          %value >>= 4;
        }

      case "f":
        %value = mFloatLength(%value, %precision $= "" ? 6 : %precision);

        if (%flag_always_sign && %value >= 0)
          %chunk = "+" @ %value;
        else if (%flag_space_sign && %value >= 0)
          %chunk = " " @ %value;
        else
          %chunk = %value;

      // %e
      // %g
      // %a

      case "c": %chunk = $chr[%value];
      case "s": %chunk = %value;
      case "n": // consume a value

      default:
        %out = %out @ getSubStr(%fmt, %i, %j - %i);
        %i = %j;
        continue;
    }

    if (%padsize !$= "")
    {
      if (%padside)
        %chunk = %chunk @ repeat(%padchar, %padsize - strlen(stripMLControlChars(%chunk)));
      else
        %chunk = repeat(%padchar, %padsize - strlen(stripMLControlChars(%chunk))) @ %chunk;
    }

    %out = %out @ %chunk;
    %i = %j + 1;
  }

  return %out;
}
